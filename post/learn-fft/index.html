<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>FFT & NTT 学习笔记 | Roger Young</title>
<meta name=keywords content="多项式">
<meta name=description content="FFT 怎么这么难啊。">
<meta name=author content="rogeryoungh">
<link rel=canonical href=https://rogeryoungh.github.io/blog/post/learn-fft/>
<link crossorigin=anonymous href=/blog/assets/css/stylesheet.min.51e56ec491ce4ddb9a51265d16c0e4cbd5305ad05fd8d750740f0182ef5ce433.css integrity="sha256-UeVuxJHOTduaUSZdFsDky9UwWtBf2NdQdA8Bgu9c5DM=" rel="preload stylesheet" as=style>
<link rel=preload href=/blog/avatar.png as=image>
<script defer crossorigin=anonymous src=/blog/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://rogeryoungh.github.io/blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://rogeryoungh.github.io/blog/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://rogeryoungh.github.io/blog/favicon-32x32.png>
<link rel=apple-touch-icon href=https://rogeryoungh.github.io/blog/apple-touch-icon.png>
<link rel=mask-icon href=https://rogeryoungh.github.io/blog/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0}}</script>
<script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js></script>
<meta property="og:title" content="FFT & NTT 学习笔记">
<meta property="og:description" content="FFT 怎么这么难啊。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://rogeryoungh.github.io/blog/post/learn-fft/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-07-22T00:00:00+00:00">
<meta property="article:modified_time" content="2021-07-22T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="FFT & NTT 学习笔记">
<meta name=twitter:description content="FFT 怎么这么难啊。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://rogeryoungh.github.io/blog/post/"},{"@type":"ListItem","position":3,"name":"FFT \u0026 NTT 学习笔记","item":"https://rogeryoungh.github.io/blog/post/learn-fft/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"FFT \u0026 NTT 学习笔记","name":"FFT \u0026 NTT 学习笔记","description":"FFT 怎么这么难啊。","keywords":["多项式"],"articleBody":"前置知识：复数，需要理解 Euler 公式。\n以下是我对 FFT 的感性理解，可能并不严谨，如有错误欢迎指正。\nFFT 多项式乘法 对于 $n$ 次多项式\n $$ \\begin{aligned} f(x) = \\sum_{i=0}^n f_ix^i \u0026= f_0 + f_1 x + f_2x^2 + \\cdots + g_nx^n \\\\ g(x) = \\sum_{i=0}^n g_ix^i \u0026= g_0 + g_1 x + g_2x^2 + \\cdots + g_nx^n \\end{aligned} $$ 它们的乘法是 $F(x) = f(x)g(x) = \\sum\\limits_{k=0}^{2n} c_kx^k$，其中\n $$ c_k = \\sum_{i+j=k}f_ig_j $$ 因此计算多项式的乘积需要 $n^2$ 次系数乘法，我们需要优化。\n点值表示法 $n$ 次多项式 $f(x)$ 可以由 $n+1$ 个系数决定，也可以由 $n+1$ 个座标（点值）决定。即 $n$ 次多项式可以看作 $n+1$ 维的向量。\n考虑选取 $2n+1$ 个座标来确定 $f(x)$ 和 $g(x)$。则 $F(x)$ 可以简单的通过做 $2n+1$ 次乘法得到\n $$ (x_k,F(x_k)) = \\left(x_k, f(x_k)g(x_k)\\right) $$ 于是求多项式的乘法，可以先从系数表示法转换为点值表示法，做完乘法再变回去。\nDFT 怎么把多项式转换成点值呢？我们有离散 Fourier 变换。称方程 $x^n = 1$ 的 $n$ 个解为单位根。\n设多项式 $f(x) = \\sum\\limits_{k=0}^{n-1} f_kx^k$，并选择一个单位根 $\\omega$，则称向量\n $$ \\operatorname{DFT}_{\\omega}(f) =( f(1), f(\\omega^1), \\cdots, f(\\omega^{n-1}) ) $$ 为 $f$ 的离散 Fourier 变换（Discrete Fourier Transform）。\nDFT 存在逆变换（IDFT），即从点值重新变回系数，仍是从向量到向量的变换。\nIDFT 存在性质\n $$ (\\operatorname{DFT}_{\\omega})^{-1} = \\frac{1}{n} (\\operatorname{DFT}_{{\\omega}^{-1}}) $$ 篇幅所限，不放证明（我不会证）。现在我们可以统一的处理 DFT 和 IDFT。\n单位原根 至此，我们计算 DFT 的复杂度仍然是 $O(n^2)$，其与 FFT 的关键差别就是选取特殊的点加速计算。\n单位根中特殊的一个记作 $\\omega_n = e^{\\frac{2 \\pi i}{n}}$，它叫做单位原根。根据 Euler 公式，有\n $$ \\omega_n = e^{\\tfrac{2 \\pi i}{n}} = \\cos \\left(\\frac{2\\pi}{n}\\right) + i \\sin \\left(\\frac{2\\pi}{n}\\right) $$ 即 $\\omega_n$ 是单位圆上的一个点，全部的 $n$ 个单位根\n $$ x_k = \\omega_n^k = e^{k\\tfrac{2 \\pi i}{n}} = \\cos \\left(\\frac{2\\pi k}{n}\\right) + i \\sin \\left(\\frac{2\\pi k}{n}\\right) $$ 恰全是单位元的 $n$ 等分点。因此根据 Euler 公式，单位根之间的乘法就是在单位元上转圈圈。\n不难通过 Euler 公式验证单位原根 $\\omega_n$ 的几条性质：\n $\\omega_{2n}^{2k} = \\omega_n^k$。 $\\omega_{2n}^{n+k} = -\\omega_{2n}^k$。  分治 利用单位原根的特殊性，我们可以分治计算 DFT。比如对于 $7$ 次多项式\n $$ \\begin{aligned} f(x) \u0026= f_0 + f_1x + f_2x^2 + f_3 x^3 + f_4 x^4 + f_5 x^5 + f_6 x^6 + f_7 x^7 \\\\ \u0026= (f_0 + f_2x^2 + f_4x^4 + f_6x^6) + x(f_1 + f_3x^2 + f_5x^4 + f_7x^6) \\end{aligned} $$ 奇偶分别建立函数\n $$ \\begin{aligned} f^{[0]}(x) \u0026= f_0 + f_2x + f_4x^2 + f_6x^3 \\\\ f^{[1]}(x) \u0026= f_1 + f_3x + f_5x^2 + f_7x^3 \\end{aligned} $$ 则原来的函数可以表示为\n $$ f(x) = f^{[0]}(x^2) + xf^{[1]}(x^2) $$ 一般的，对于度小于 $n$ 的多项式 $f(x)$，利用单位原根的性质有\n $$ \\begin{aligned} f(\\omega_{n}^k) \u0026= f^{[0]}(\\omega_{n}^k \\cdot \\omega_{n}^k) + \\omega_{n}^kf^{[1]}(\\omega_{n}^k \\cdot \\omega_{n}^k) \\\\ \u0026= f^{[0]}(\\omega_{n}^{2k}) + \\omega_{n}^kf^{[1]}(\\omega_{n}^{2k}) \\\\ \u0026= f^{[0]}(\\omega_{n/2}^{k}) + \\omega_{n}^kf^{[1]}(\\omega_{n/2}^{k}) \\end{aligned} $$ 同理可得\n $$ \\begin{aligned} f(\\omega_{n}^{k+n/2}) \u0026= f^{[0]}(\\omega_{n}^{2k+n}) + \\omega_{n}^{k+n/2}f^{[1]}(\\omega_{n}^{2k+n}) \\\\ \u0026= f^{[0]}(\\omega_{n/2}^{k}) - \\omega_{n}^{k}f^{[1]}(\\omega_{n/2}^{k}) \\end{aligned} $$ 因此我们需要把多项式的系数向上补到 $2^n$ 个，方便分治。\n在 DFT 中使用有\n $$ \\begin{aligned} \\operatorname{DFT}_{\\omega}(f)[j] \u0026= \\operatorname{DFT}_{\\omega^2}(f^{[0]})[j] + \\omega^j \\operatorname{DFT}_{\\omega^2}(f^{[1]})[j] \\\\ \\operatorname{DFT}_{\\omega}(f)[j + n/2] \u0026= \\operatorname{DFT}_{\\omega^2}(f^{[0]})[j] - \\omega^j\\operatorname{DFT}_{\\omega^2}(f^{[1]})[j] \\end{aligned} $$ 至此，我们可以写出递归版的 FFT。\nvoid FFT(Comp *f, int n, int type) { if (n == 1) return; for (int i = 0; i  n; i++) tmp[i] = f[i]; for (int i = 0; i  n; i++) { // 偶数放左边，奇数放右边  if (i \u0026 1) f[n / 2 + i / 2] = tmp[i]; else f[i / 2] = tmp[i]; } Comp *g = f, *h = f + n / 2; DFT(g, n / 2, type), DFT(h, n / 2, type); Comp step(cos(2 * PI / n), sin(2 * PI * type / n)), cur(1, 0); for (int k = 0; k  n / 2; k++) { tmp[k] = g[k] + cur * h[k]; tmp[k + n / 2] = g[k] - cur * h[k]; cur = cur * step; } for (int i = 0; i  n; i++) f[i] = tmp[i]; } 蝴蝶变换 递归分治总是不尽人意的，如果能一次到位就更好了。还是以 $7$ 次多项式为例\n 初始 ${x^0,x^1,x^2,x^3,x^4,x^5,x^6,x^7}$ 一次 ${x^0,x^2,x^4,x^6},{x^1,x^3,x^5,x^7}$ 两次 ${x^0,x^4},{x^2,x^6},{x^1,x^5},{x^3,x^7}$ 结束 ${x^0},{x^4},{x^2},{x^6},{x^1},{x^5},{x^3},{x^7}$  写出二进制的形式，可以发现规律\n   初始 0 1 2 3 4 5 6 7     初始(2) 000 001 010 011 100 101 110 111   结束(2) 000 100 010 110 001 101 011 111   结束 0 4 2 6 1 5 3 7    结束和开始的二进制恰好是相反的。这个变换称为蝴蝶变换，也称位逆序置换（bit-reversal permutation）。\n我们可以 $O(n)$ 的预处理出变换数组。设 R(x) 是 $x$ 的变换结果，则 R(x1) 是已求的。\n $$ \\begin{aligned} \\texttt{000abcd} \u0026\\to \\texttt{dcba000} \\\\ \\texttt{00abcdx} \u0026\\to \\texttt{xdcba00} \\end{aligned} $$ 即是把 R(x1) 右移一位再补上最高位即可。代码如下\nint lim = 1, lim_2; while (lim  n + m) lim  1; lim_2 = lim  1; for (int i = 0; i  lim; ++i) { rev[i] = rev[i  1]  1; if (i \u0026 1) rev[i] |= lim  1; // 或者合并写为  // rev[i] = (rev[i  1]  1) | ((i \u0026 1) * lim_2); } 现在我们可以写出非递归版的 FFT。\nvoid FFT(Comp *f, int n, int type) { for (int i = 0; i  n; ++i) { if (i  rev[i]) { swap(f[i], f[rev[i]]); } } for (int h = 2; h  n; h  1) { Comp step(cos(2 * PI / h), sin(2 * PI * type / h)); for (int j = 0; j  n; j += h) { Comp cur(1, 0); for (int k = j; k  j + h / 2; k++) { Comp f1 = f[k], f2 = cur * f[k + h / 2]; f[k] = f1 + f2; f[k + h / 2] = f1 - f2; cur = cur * step; } } } if (type == 1) return; for (int i = 0; i  n; i++) f[i].x /= n, f[i].y /= n; } NTT 前置知识：数论基础（整除，同余）。\n用 double 去实现整数的乘法是很不优美的，精度、速度都很成问题。实际上，我们可以仅在整数下进行运算。\n原根 我们本质上用到的单位原根 $\\omega_n$ 的两个性质是：\n $\\omega_{n}^{n} = 1$。 $\\omega_{2n}^{n} = -1$。  可以联想到模 $p$ 剩余类域 $\\mathbb{Z}_p$：其中的元素是 $\\{0,1,\\cdots,p-1\\}$，其上的运算都是模 $p$ 的。由于 Fermat 小定理\n $$ a^{\\varphi(p)} = a^{p-1} \\equiv 1 $$ 即从另一个角度说，$p-1$ 个正整数都是同余方程 $x^{p-1} \\equiv 1$ 的解。\n它和单位根有很相似的形式，直觉上 $\\mathbb{Z}_p$ 也存在类似单位原根的特殊数字。下面我们在 $\\mathbb{Z}_p$ 上讨论，尝试证明这个数字存在。\n定义正整数 $a \\in \\mathbb{Z}_p$ 的阶 $\\delta_p(a)$ 为最小的 $r$ 使得 $a^r \\equiv 1$。由 Fermat 小定理 $a^{\\varphi(p)} \\equiv 1$，因此 $a$ 的阶一定存在且有 $\\delta_p(a) \\mid \\varphi(p)$。可以证明\n $$ a,a^2,\\cdots a^{\\delta_p(a)} \\tag{1} $$ 在模 $p$ 下余数互不相同。由 Lagrange 定理，$x^{\\delta_p(a)} \\equiv 1$ 的解至多有 $\\delta_p(a)$ 个，恰是 $(1)$ 中所展示的。\n通过整除的性质，可以想到只有 $i \\bot \\delta_p(a)$ 才有 $\\delta_p(a^i) = \\delta_p(a)$，即 $a$ 总是附带着\n $$ \\sum_{i=1}^{\\delta_p(a)} [\\gcd(i, \\delta_p(a)) = 1] = \\varphi(\\delta_p(a)) $$ 个阶相同的东西。因此阶为 $\\delta_p(a)$ 的数恰有 $\\varphi(\\delta_p(a))$ 个。\n因为每个正整数都有唯一确定的阶，不妨假设对于所有 $d \\mid \\varphi(p)$，阶 $d$ 都存在 $\\varphi(d)$ 个对应的整数，统计整数个数\n $$ \\sum_{d \\mid \\varphi(p)} \\varphi(d) = \\varphi(p) = p - 1 $$ 恰为 $\\mathbb{Z}_p$ 全部正整数的个数，因此假设成立，也就存在 $a$ 使得 $\\delta_p(a) = p-1$。\n我们称这个 $a$ 是模 $p$ 下的一个原根，常用字母 $g$ 表示。\n快速数论变换 尽可能提取 $p - 1$ 的因子 $2$ 有\n $$ p = N q + 1, N = 2^m $$ 设 $\\mathbb{Z}_p$ 的一个原根 $g$，将 $g_N \\equiv g^q$ 看作 $\\omega_n$ 的等价。利用二次剩余的知识不难得到 $g_N^N \\equiv 1$ 和 $g_N^{N/2} \\equiv -1$。\n常见的有\n $$ \\begin{aligned} p = 1004535809 = 479 \\times 2^{21} + 1\u0026, g = 3 \\\\ p = 998244353 = 7 \\times 17 \\times 2^{23} + 1\u0026, g = 3 \\end{aligned} $$ 类似的，我们可以写出程序\nvoid NTT(ll *f, int n, int type) { for (int i = 0; i  n; ++i) { if (i  rev[i]) { swap(f[i], f[rev[i]]); } } for (int h = 2; h  n; h  1) { ll tg = type == 1 ? 3 : g_inv; ll gn = qpow(tg, (mod - 1) / h); for (int j = 0; j  n; j += h) { ll g = 1; for (int k = j; k  j + h / 2; k++) { ll f1 = f[k], f2 = g * f[k + h / 2] % mod; f[k] = mo(f1 + f2); f[k + h / 2] = mo(f1 - f2); g = g * gn % mod; } } } if (type == 1) return; ll lim_inv = inv(n); for (int i = 0; i  n; i++) f[i] = f[i] * lim_inv % mod; } 应用 FFT P3803 多项式乘法 实战一下：P3803 多项式乘法。\n我们的计算步骤是：\nFFT(F, lim, 1); FFT(G, lim, 1); for (int i = 0; i  lim; i++) F[i] = F[i] * G[i]; FFT(F, lim, -1); 实际上，我们并不用三次 FFT，两次足以。注意到若把 $F(x)$ 放在实部而 $G(x)$ 放在虚部\n $$ (F + iG)^2 = (F^2-G^2) + 2iFG $$ 平方之后虚部恰是答案。\n这里展示全部的代码，帮助大家理解。\nFFT 模板（P3803 多项式乘法） const double PI = acos(-1.0); const int MAXN = 4e6 + 10; struct Comp { double x, y; Comp(double xx = 0, double yy = 0) { x = xx, y = yy; } Comp operator+(Comp c) { return Comp(x + c.x, y + c.y); } Comp operator-(Comp c) { return Comp(x - c.x, y - c.y); } Comp operator*(Comp c) { double tx = x * c.x - y * c.y; double ty = x * c.y + y * c.x; return Comp(tx, ty); } }; Comp ff[MAXN]; int rev[MAXN]; void FFT(Comp *f, int n, int type) { for (int i = 0; i  n; ++i) { if (i  rev[i]) { swap(f[i], f[rev[i]]); } } for (int h = 2; h  n; h  1) { Comp step(cos(2 * PI / h), sin(2 * PI * type / h)); for (int j = 0; j  n; j += h) { Comp cur(1, 0); for (int k = j; k  j + h / 2; k++) { Comp f1 = f[k], f2 = f[k + h / 2]; f[k] = f1 + cur * f2; f[k + h / 2] = f1 - cur * f2; cur = cur * step; } } } if (type == 1) return; for (int i = 0; i  n; i++) f[i].x /= n, f[i].y /= n; } int main() { int n = rr(), m = rr(); for (int i = 0; i  n; i++) ff[i].x = rr(); for (int i = 0; i  m; i++) ff[i].y = rr(); int lim = 1, lim_2; while (lim  n + m) lim  1; lim_2 = lim  1; for (int i = 0; i  lim; ++i) rev[i] = (rev[i  1]  1) | ((i \u0026 1) * lim_2); FFT(ff, lim, 1); for (int i = 0; i  lim; i++) ff[i] = ff[i] * ff[i]; FFT(ff, lim, -1); for (int i = 0; i  m + n; i++) printf(\"%d \", int(ff[i].y / 2 + 0.5)); return 0; }    NTT P3803 多项式乘法 NTT 再来一遍。\nNTT 模板（P3803 多项式乘法） const ll mod = 998244353, g = 3; const ll MAXN = 4e6 + 10; ll qpow(ll a, ll b, ll p = mod) { ll ret = p != 1; for (; b; b = 1) { if (b \u0026 1) ret = a * ret % p; a = a * a % p; } return ret; } ll inv(ll a) { return qpow(a, mod - 2); } ll mo(ll n) { return (n + mod) % mod; } const ll g_inv = inv(g); ll ff[MAXN], gg[MAXN]; int rev[MAXN]; void NTT(ll *f, int n, int type) { for (int i = 0; i  n; ++i) { if (i  rev[i]) { swap(f[i], f[rev[i]]); } } for (int h = 2; h  n; h  1) { ll tg = type == 1 ? 3 : g_inv; ll gn = qpow(tg, (mod - 1) / h); for (int j = 0; j  n; j += h) { ll g = 1; for (int k = j; k  j + h / 2; k++) { ll f1 = f[k], f2 = g * f[k + h / 2] % mod; f[k] = mo(f1 + f2); f[k + h / 2] = mo(f1 - f2); g = g * gn % mod; } } } if (type == 1) return; ll lim_inv = inv(n); for (int i = 0; i  n; i++) f[i] = f[i] * lim_inv % mod; } int main() { int n = rr(), m = rr(); for (int i = 0; i  n; i++) ff[i] = rr(); for (int i = 0; i  m; i++) gg[i] = rr(); int lim = 1, lim_2; while (lim  n + m) lim  1; lim_2 = lim  1; for (int i = 0; i  lim; ++i) rev[i] = (rev[i  1]  1) | ((i \u0026 1) * lim_2); NTT(ff, lim, 1); NTT(gg, lim, 1); for (int i = 0; i  lim; i++) ff[i] = ff[i] * gg[i]; NTT(ff, lim, -1); for (int i = 0; i  m + n; i++) printf(\"%lld \", ff[i]); return 0; }    ","wordCount":"1895","inLanguage":"en","datePublished":"2021-07-22T00:00:00Z","dateModified":"2021-07-22T00:00:00Z","author":{"@type":"Person","name":"rogeryoungh"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rogeryoungh.github.io/blog/post/learn-fft/"},"publisher":{"@type":"Organization","name":"Roger Young","logo":{"@type":"ImageObject","url":"https://rogeryoungh.github.io/blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://rogeryoungh.github.io/blog accesskey=h title="Roger Young (Alt + H)">Roger Young</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://rogeryoungh.github.io/blog/post title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://rogeryoungh.github.io/blog/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://rogeryoungh.github.io/blog/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://rogeryoungh.github.io/blog/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
FFT & NTT 学习笔记
</h1>
<div class=post-meta>July 22, 2021&nbsp;·&nbsp;rogeryoungh
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>Table of Contents</div>
</summary>
<div class=inner><ul>
<li>
<a href=#fft aria-label=FFT>FFT</a><ul>
<li>
<a href=#%e5%a4%9a%e9%a1%b9%e5%bc%8f%e4%b9%98%e6%b3%95 aria-label=多项式乘法>多项式乘法</a></li>
<li>
<a href=#%e7%82%b9%e5%80%bc%e8%a1%a8%e7%a4%ba%e6%b3%95 aria-label=点值表示法>点值表示法</a></li>
<li>
<a href=#dft aria-label=DFT>DFT</a></li>
<li>
<a href=#%e5%8d%95%e4%bd%8d%e5%8e%9f%e6%a0%b9 aria-label=单位原根>单位原根</a></li>
<li>
<a href=#%e5%88%86%e6%b2%bb aria-label=分治>分治</a></li>
<li>
<a href=#%e8%9d%b4%e8%9d%b6%e5%8f%98%e6%8d%a2 aria-label=蝴蝶变换>蝴蝶变换</a></li></ul>
</li>
<li>
<a href=#ntt aria-label=NTT>NTT</a><ul>
<li>
<a href=#%e5%8e%9f%e6%a0%b9 aria-label=原根>原根</a></li>
<li>
<a href=#%e5%bf%ab%e9%80%9f%e6%95%b0%e8%ae%ba%e5%8f%98%e6%8d%a2 aria-label=快速数论变换>快速数论变换</a></li></ul>
</li>
<li>
<a href=#%e5%ba%94%e7%94%a8 aria-label=应用>应用</a><ul>
<li>
<a href=#fft-p3803-%e5%a4%9a%e9%a1%b9%e5%bc%8f%e4%b9%98%e6%b3%95 aria-label="FFT P3803 多项式乘法">FFT P3803 多项式乘法</a></li>
<li>
<a href=#ntt-p3803-%e5%a4%9a%e9%a1%b9%e5%bc%8f%e4%b9%98%e6%b3%95 aria-label="NTT P3803 多项式乘法">NTT P3803 多项式乘法</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>前置知识：复数，需要理解 Euler 公式。</p>
<p>以下是我对 FFT 的感性理解，可能并不严谨，如有错误欢迎指正。</p>
<h2 id=fft>FFT<a hidden class=anchor aria-hidden=true href=#fft>#</a></h2>
<h3 id=多项式乘法>多项式乘法<a hidden class=anchor aria-hidden=true href=#多项式乘法>#</a></h3>
<p>对于 $n$ 次多项式</p>
<p> $$
\begin{aligned}
f(x) = \sum_{i=0}^n f_ix^i &=  f_0 + f_1 x + f_2x^2 + \cdots + g_nx^n \\
g(x) = \sum_{i=0}^n g_ix^i &=  g_0 + g_1 x + g_2x^2 + \cdots + g_nx^n
\end{aligned}
$$ </p>
<p>它们的乘法是 $F(x) = f(x)g(x) = \sum\limits_{k=0}^{2n} c_kx^k$，其中</p>
<p> $$
c_k = \sum_{i+j=k}f_ig_j
$$ </p>
<p>因此计算多项式的乘积需要 $n^2$ 次系数乘法，我们需要优化。</p>
<h3 id=点值表示法>点值表示法<a hidden class=anchor aria-hidden=true href=#点值表示法>#</a></h3>
<p>$n$ 次多项式 $f(x)$ 可以由 $n+1$ 个系数决定，也可以由 $n+1$ 个座标（点值）决定。即 $n$ 次多项式可以看作 $n+1$ 维的向量。</p>
<p>考虑选取 $2n+1$ 个座标来确定 $f(x)$ 和 $g(x)$。则 $F(x)$ 可以简单的通过做 $2n+1$ 次乘法得到</p>
<p> $$
(x_k,F(x_k)) = \left(x_k, f(x_k)g(x_k)\right)
$$ </p>
<p>于是求多项式的乘法，可以先从系数表示法转换为点值表示法，做完乘法再变回去。</p>
<h3 id=dft>DFT<a hidden class=anchor aria-hidden=true href=#dft>#</a></h3>
<p>怎么把多项式转换成点值呢？我们有离散 Fourier 变换。称方程 $x^n = 1$ 的 $n$ 个解为单位根。</p>
<p>设多项式 $f(x) = \sum\limits_{k=0}^{n-1} f_kx^k$，并选择一个单位根 $\omega$，则称向量</p>
<p> $$
\operatorname{DFT}_{\omega}(f) =( f(1), f(\omega^1), \cdots, f(\omega^{n-1}) )
$$ </p>
<p>为 $f$ 的离散 Fourier 变换（Discrete Fourier Transform）。</p>
<p>DFT 存在逆变换（IDFT），即从点值重新变回系数，仍是从向量到向量的变换。</p>
<p>IDFT 存在性质</p>
<p> $$
(\operatorname{DFT}_{\omega})^{-1} = \frac{1}{n} (\operatorname{DFT}_{{\omega}^{-1}})
$$ </p>
<p>篇幅所限，不放证明（<del>我不会证</del>）。现在我们可以统一的处理 DFT 和 IDFT。</p>
<h3 id=单位原根>单位原根<a hidden class=anchor aria-hidden=true href=#单位原根>#</a></h3>
<p>至此，我们计算 DFT 的复杂度仍然是 $O(n^2)$，其与 FFT 的关键差别就是选取特殊的点加速计算。</p>
<p>单位根中特殊的一个记作 $\omega_n = e^{\frac{2 \pi i}{n}}$，它叫做单位原根。根据 Euler 公式，有</p>
<p> $$
\omega_n = e^{\tfrac{2 \pi i}{n}} = \cos \left(\frac{2\pi}{n}\right) + i \sin \left(\frac{2\pi}{n}\right)
$$ </p>
<p>即 $\omega_n$ 是单位圆上的一个点，全部的 $n$ 个单位根</p>
<p> $$
x_k = \omega_n^k = e^{k\tfrac{2 \pi i}{n}} = \cos \left(\frac{2\pi k}{n}\right) + i \sin \left(\frac{2\pi k}{n}\right)
$$ </p>
<p>恰全是单位元的 $n$ 等分点。因此根据 Euler 公式，<strong>单位根之间的乘法就是在单位元上转圈圈。</strong></p>
<p>不难通过 Euler 公式验证单位原根 $\omega_n$ 的几条性质：</p>
<ul>
<li>$\omega_{2n}^{2k} = \omega_n^k$。</li>
<li>$\omega_{2n}^{n+k} = -\omega_{2n}^k$。</li>
</ul>
<h3 id=分治>分治<a hidden class=anchor aria-hidden=true href=#分治>#</a></h3>
<p>利用单位原根的特殊性，我们可以分治计算 DFT。比如对于 $7$ 次多项式</p>
<p> $$
\begin{aligned}
f(x) &= f_0 + f_1x + f_2x^2 + f_3 x^3 + f_4 x^4 + f_5 x^5 + f_6 x^6 + f_7 x^7 \\
&= (f_0 + f_2x^2 + f_4x^4 + f_6x^6) + x(f_1 + f_3x^2 + f_5x^4 + f_7x^6)
\end{aligned}
$$ </p>
<p>奇偶分别建立函数</p>
<p> $$
\begin{aligned}
f^{[0]}(x) &= f_0 + f_2x + f_4x^2 + f_6x^3 \\
f^{[1]}(x) &= f_1 + f_3x + f_5x^2 + f_7x^3
\end{aligned}
$$ </p>
<p>则原来的函数可以表示为</p>
<p> $$
f(x) = f^{[0]}(x^2) + xf^{[1]}(x^2)
$$ </p>
<p>一般的，对于度小于 $n$ 的多项式 $f(x)$，利用单位原根的性质有</p>
<p> $$
\begin{aligned}
f(\omega_{n}^k) &= f^{[0]}(\omega_{n}^k \cdot \omega_{n}^k) + \omega_{n}^kf^{[1]}(\omega_{n}^k \cdot \omega_{n}^k) \\
&= f^{[0]}(\omega_{n}^{2k}) + \omega_{n}^kf^{[1]}(\omega_{n}^{2k}) \\
&= f^{[0]}(\omega_{n/2}^{k}) + \omega_{n}^kf^{[1]}(\omega_{n/2}^{k})
\end{aligned}
$$ </p>
<p>同理可得</p>
<p> $$
\begin{aligned}
f(\omega_{n}^{k+n/2}) &= f^{[0]}(\omega_{n}^{2k+n}) + \omega_{n}^{k+n/2}f^{[1]}(\omega_{n}^{2k+n}) \\
&= f^{[0]}(\omega_{n/2}^{k}) - \omega_{n}^{k}f^{[1]}(\omega_{n/2}^{k})
\end{aligned}
$$ </p>
<p>因此我们需要把多项式的系数向上补到 $2^n$ 个，方便分治。</p>
<p>在 DFT 中使用有</p>
<p> $$
\begin{aligned}
\operatorname{DFT}_{\omega}(f)[j] &= \operatorname{DFT}_{\omega^2}(f^{[0]})[j] + \omega^j \operatorname{DFT}_{\omega^2}(f^{[1]})[j] \\
\operatorname{DFT}_{\omega}(f)[j + n/2] &= \operatorname{DFT}_{\omega^2}(f^{[0]})[j] - \omega^j\operatorname{DFT}_{\omega^2}(f^{[1]})[j]
\end{aligned}
$$ </p>
<p>至此，我们可以写出递归版的 FFT。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>void</span> <span class=nf>FFT</span><span class=p>(</span><span class=n>Comp</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>tmp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 偶数放左边，奇数放右边
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>f</span><span class=p>[</span><span class=n>n</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>+</span> <span class=n>i</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>tmp</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=k>else</span>
            <span class=n>f</span><span class=p>[</span><span class=n>i</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>tmp</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
    <span class=p>}</span>
    <span class=n>Comp</span> <span class=o>*</span><span class=n>g</span> <span class=o>=</span> <span class=n>f</span><span class=p>,</span> <span class=o>*</span><span class=n>h</span> <span class=o>=</span> <span class=n>f</span> <span class=o>+</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
    <span class=n>DFT</span><span class=p>(</span><span class=n>g</span><span class=p>,</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>type</span><span class=p>),</span> <span class=n>DFT</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>type</span><span class=p>);</span>
    <span class=n>Comp</span> <span class=n>step</span><span class=p>(</span><span class=n>cos</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>/</span> <span class=n>n</span><span class=p>),</span> <span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>*</span> <span class=n>type</span> <span class=o>/</span> <span class=n>n</span><span class=p>)),</span> <span class=n>cur</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>tmp</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>g</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>+</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>h</span><span class=p>[</span><span class=n>k</span><span class=p>];</span>
        <span class=n>tmp</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>g</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>h</span><span class=p>[</span><span class=n>k</span><span class=p>];</span>
        <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>step</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>tmp</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><h3 id=蝴蝶变换>蝴蝶变换<a hidden class=anchor aria-hidden=true href=#蝴蝶变换>#</a></h3>
<p>递归分治总是不尽人意的，如果能一次到位就更好了。还是以 $7$ 次多项式为例</p>
<ul>
<li>初始 ${x^0,x^1,x^2,x^3,x^4,x^5,x^6,x^7}$</li>
<li>一次 ${x^0,x^2,x^4,x^6},{x^1,x^3,x^5,x^7}$</li>
<li>两次 ${x^0,x^4},{x^2,x^6},{x^1,x^5},{x^3,x^7}$</li>
<li>结束 ${x^0},{x^4},{x^2},{x^6},{x^1},{x^5},{x^3},{x^7}$</li>
</ul>
<p>写出二进制的形式，可以发现规律</p>
<table>
<thead>
<tr>
<th style=text-align:center>初始</th>
<th style=text-align:center>0</th>
<th style=text-align:center>1</th>
<th style=text-align:center>2</th>
<th style=text-align:center>3</th>
<th style=text-align:center>4</th>
<th style=text-align:center>5</th>
<th style=text-align:center>6</th>
<th style=text-align:center>7</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>初始(2)</td>
<td style=text-align:center>000</td>
<td style=text-align:center>001</td>
<td style=text-align:center>010</td>
<td style=text-align:center>011</td>
<td style=text-align:center>100</td>
<td style=text-align:center>101</td>
<td style=text-align:center>110</td>
<td style=text-align:center>111</td>
</tr>
<tr>
<td style=text-align:center>结束(2)</td>
<td style=text-align:center>000</td>
<td style=text-align:center>100</td>
<td style=text-align:center>010</td>
<td style=text-align:center>110</td>
<td style=text-align:center>001</td>
<td style=text-align:center>101</td>
<td style=text-align:center>011</td>
<td style=text-align:center>111</td>
</tr>
<tr>
<td style=text-align:center>结束</td>
<td style=text-align:center>0</td>
<td style=text-align:center>4</td>
<td style=text-align:center>2</td>
<td style=text-align:center>6</td>
<td style=text-align:center>1</td>
<td style=text-align:center>5</td>
<td style=text-align:center>3</td>
<td style=text-align:center>7</td>
</tr>
</tbody>
</table>
<p>结束和开始的二进制恰好是相反的。这个变换称为蝴蝶变换，也称位逆序置换（bit-reversal permutation）。</p>
<p>我们可以 $O(n)$ 的预处理出变换数组。设 <code>R(x)</code> 是 $x$ 的变换结果，则 <code>R(x>>1)</code> 是已求的。</p>
<p> $$
\begin{aligned}
\texttt{000abcd} &\to \texttt{dcba000} \\
\texttt{00abcdx} &\to \texttt{xdcba00}
\end{aligned}
$$ </p>
<p>即是把 <code>R(x>>1)</code> 右移一位再补上最高位即可。代码如下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>int</span> <span class=n>lim</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lim_2</span><span class=p>;</span>
<span class=k>while</span> <span class=p>(</span><span class=n>lim</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>+</span> <span class=n>m</span><span class=p>)</span>
    <span class=n>lim</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
<span class=n>lim_2</span> <span class=o>=</span> <span class=n>lim</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>lim</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>rev</span><span class=p>[</span><span class=n>i</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
        <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>|=</span> <span class=n>lim</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
    <span class=c1>// 或者合并写为
</span><span class=c1></span>    <span class=c1>// rev[i] = (rev[i &gt;&gt; 1] &gt;&gt; 1) | ((i &amp; 1) * lim_2);
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>现在我们可以写出非递归版的 FFT。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>void</span> <span class=nf>FFT</span><span class=p>(</span><span class=n>Comp</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
            <span class=n>swap</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>f</span><span class=p>[</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Comp</span> <span class=n>step</span><span class=p>(</span><span class=n>cos</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>/</span> <span class=n>h</span><span class=p>),</span> <span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>*</span> <span class=n>type</span> <span class=o>/</span> <span class=n>h</span><span class=p>));</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>j</span> <span class=o>+=</span> <span class=n>h</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Comp</span> <span class=n>cur</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>j</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Comp</span> <span class=n>f1</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>];</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>f1</span> <span class=o>+</span>  <span class=n>f2</span><span class=p>;</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>f1</span> <span class=o>-</span> <span class=n>f2</span><span class=p>;</span>
                <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>step</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>/=</span> <span class=n>n</span><span class=p>,</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>/=</span> <span class=n>n</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=ntt>NTT<a hidden class=anchor aria-hidden=true href=#ntt>#</a></h2>
<p>前置知识：数论基础（整除，同余）。</p>
<p>用 <code>double</code> 去实现整数的乘法是很不优美的，精度、速度都很成问题。实际上，我们可以仅在整数下进行运算。</p>
<h3 id=原根>原根<a hidden class=anchor aria-hidden=true href=#原根>#</a></h3>
<p>我们本质上用到的单位原根 $\omega_n$ 的两个性质是：</p>
<ul>
<li>$\omega_{n}^{n} = 1$。</li>
<li>$\omega_{2n}^{n} = -1$。</li>
</ul>
<p>可以联想到模 $p$ 剩余类域 $\mathbb{Z}_p$：其中的元素是 $\{0,1,\cdots,p-1\}$，其上的运算都是模 $p$ 的。由于 Fermat 小定理</p>
<p> $$
a^{\varphi(p)} = a^{p-1} \equiv 1
$$ </p>
<p>即从另一个角度说，$p-1$ 个正整数都是同余方程 $x^{p-1} \equiv 1$ 的解。</p>
<p>它和单位根有很相似的形式，直觉上 $\mathbb{Z}_p$ 也存在类似单位原根的特殊数字。下面我们在 $\mathbb{Z}_p$ 上讨论，尝试证明这个数字存在。</p>
<p>定义正整数 $a \in \mathbb{Z}_p$ 的阶 $\delta_p(a)$ 为最小的 $r$ 使得 $a^r \equiv 1$。由 Fermat 小定理 $a^{\varphi(p)} \equiv 1$，因此 $a$ 的阶一定存在且有 $\delta_p(a) \mid \varphi(p)$。可以证明</p>
<p> $$
a,a^2,\cdots a^{\delta_p(a)} \tag{1}
$$ </p>
<p>在模 $p$ 下余数互不相同。由 Lagrange 定理，$x^{\delta_p(a)} \equiv 1$ 的解至多有 $\delta_p(a)$ 个，恰是 $(1)$ 中所展示的。</p>
<p>通过整除的性质，可以想到只有 $i \bot \delta_p(a)$ 才有 $\delta_p(a^i) = \delta_p(a)$，即 $a$ 总是附带着</p>
<p> $$
\sum_{i=1}^{\delta_p(a)} [\gcd(i, \delta_p(a)) = 1] = \varphi(\delta_p(a))
$$ </p>
<p>个阶相同的东西。因此阶为 $\delta_p(a)$ 的数恰有 $\varphi(\delta_p(a))$ 个。</p>
<p>因为每个正整数都有唯一确定的阶，不妨假设对于所有 $d \mid \varphi(p)$，阶 $d$ 都存在 $\varphi(d)$ 个对应的整数，统计整数个数</p>
<p> $$
\sum_{d \mid \varphi(p)} \varphi(d) = \varphi(p) = p - 1
$$ </p>
<p>恰为 $\mathbb{Z}_p$ 全部正整数的个数，因此假设成立，也就存在 $a$ 使得 $\delta_p(a) = p-1$。</p>
<p>我们称这个 $a$ 是模 $p$ 下的一个原根，常用字母 $g$ 表示。</p>
<h3 id=快速数论变换>快速数论变换<a hidden class=anchor aria-hidden=true href=#快速数论变换>#</a></h3>
<p>尽可能提取 $p - 1$ 的因子 $2$ 有</p>
<p> $$
p = N q + 1, N = 2^m
$$ </p>
<p>设 $\mathbb{Z}_p$ 的一个原根 $g$，将 $g_N \equiv g^q$ 看作 $\omega_n$ 的等价。利用二次剩余的知识不难得到 $g_N^N \equiv 1$ 和 $g_N^{N/2} \equiv -1$。</p>
<p>常见的有</p>
<p> $$
\begin{aligned}
p = 1004535809 = 479 \times 2^{21} + 1&, g = 3 \\
p = 998244353 = 7 \times 17 \times 2^{23} + 1&, g = 3
\end{aligned}
$$ </p>
<p>类似的，我们可以写出程序</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=kt>void</span> <span class=nf>NTT</span><span class=p>(</span><span class=n>ll</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
            <span class=n>swap</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>f</span><span class=p>[</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ll</span> <span class=n>tg</span> <span class=o>=</span> <span class=n>type</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=mi>3</span> <span class=o>:</span> <span class=n>g_inv</span><span class=p>;</span>
        <span class=n>ll</span> <span class=n>gn</span> <span class=o>=</span> <span class=n>qpow</span><span class=p>(</span><span class=n>tg</span><span class=p>,</span> <span class=p>(</span><span class=n>mod</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>h</span><span class=p>);</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>j</span> <span class=o>+=</span> <span class=n>h</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ll</span> <span class=n>g</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>j</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>ll</span> <span class=n>f1</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>g</span> <span class=o>*</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>mo</span><span class=p>(</span><span class=n>f1</span> <span class=o>+</span> <span class=n>f2</span><span class=p>);</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>mo</span><span class=p>(</span><span class=n>f1</span> <span class=o>-</span> <span class=n>f2</span><span class=p>);</span>
                <span class=n>g</span> <span class=o>=</span> <span class=n>g</span> <span class=o>*</span> <span class=n>gn</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=n>ll</span> <span class=n>lim_inv</span> <span class=o>=</span> <span class=n>inv</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>lim_inv</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=应用>应用<a hidden class=anchor aria-hidden=true href=#应用>#</a></h2>
<h3 id=fft-p3803-多项式乘法>FFT P3803 多项式乘法<a hidden class=anchor aria-hidden=true href=#fft-p3803-多项式乘法>#</a></h3>
<p>实战一下：<a href=https://www.luogu.com.cn/problem/P3803>P3803 多项式乘法</a>。</p>
<p>我们的计算步骤是：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>FFT</span><span class=p>(</span><span class=n>F</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
<span class=n>FFT</span><span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>lim</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
    <span class=n>F</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>F</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>G</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
<span class=n>FFT</span><span class=p>(</span><span class=n>F</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</code></pre></div><p>实际上，我们并不用三次 FFT，两次足以。注意到若把 $F(x)$ 放在实部而 $G(x)$ 放在虚部</p>
<p> $$
(F + iG)^2 = (F^2-G^2) + 2iFG
$$ </p>
<p>平方之后虚部恰是答案。</p>
<p>这里展示全部的代码，帮助大家理解。</p>
<div class=toc>
<details>
<summary markdown=span>FFT 模板（P3803 多项式乘法）</summary>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>const</span> <span class=kt>double</span> <span class=n>PI</span> <span class=o>=</span> <span class=n>acos</span><span class=p>(</span><span class=o>-</span><span class=mf>1.0</span><span class=p>);</span>

<span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mf>4e6</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>

<span class=k>struct</span> <span class=nc>Comp</span> <span class=p>{</span>
    <span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
    <span class=n>Comp</span><span class=p>(</span><span class=kt>double</span> <span class=n>xx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=kt>double</span> <span class=n>yy</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>x</span> <span class=o>=</span> <span class=n>xx</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>yy</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>Comp</span> <span class=k>operator</span><span class=o>+</span><span class=p>(</span><span class=n>Comp</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nf>Comp</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>c</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=n>c</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>Comp</span> <span class=k>operator</span><span class=o>-</span><span class=p>(</span><span class=n>Comp</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nf>Comp</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>c</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>-</span> <span class=n>c</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>Comp</span> <span class=k>operator</span><span class=o>*</span><span class=p>(</span><span class=n>Comp</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>double</span> <span class=n>tx</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>c</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span> <span class=o>*</span> <span class=n>c</span><span class=p>.</span><span class=n>y</span><span class=p>;</span>
        <span class=kt>double</span> <span class=n>ty</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>c</span><span class=p>.</span><span class=n>y</span> <span class=o>+</span> <span class=n>y</span> <span class=o>*</span> <span class=n>c</span><span class=p>.</span><span class=n>x</span><span class=p>;</span>
        <span class=k>return</span> <span class=nf>Comp</span><span class=p>(</span><span class=n>tx</span><span class=p>,</span> <span class=n>ty</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=n>Comp</span> <span class=n>ff</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
<span class=kt>int</span> <span class=n>rev</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>

<span class=kt>void</span> <span class=nf>FFT</span><span class=p>(</span><span class=n>Comp</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
            <span class=n>swap</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>f</span><span class=p>[</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Comp</span> <span class=n>step</span><span class=p>(</span><span class=n>cos</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>/</span> <span class=n>h</span><span class=p>),</span> <span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>PI</span> <span class=o>*</span> <span class=n>type</span> <span class=o>/</span> <span class=n>h</span><span class=p>));</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>j</span> <span class=o>+=</span> <span class=n>h</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Comp</span> <span class=n>cur</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>j</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Comp</span> <span class=n>f1</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>];</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>f1</span> <span class=o>+</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>f2</span><span class=p>;</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>f1</span> <span class=o>-</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>f2</span><span class=p>;</span>
                <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>*</span> <span class=n>step</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>  <span class=k>return</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>/=</span> <span class=n>n</span><span class=p>,</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>/=</span> <span class=n>n</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=n>rr</span><span class=p>(),</span> <span class=n>m</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>

    <span class=kt>int</span> <span class=n>lim</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lim_2</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>lim</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>+</span> <span class=n>m</span><span class=p>)</span>
        <span class=n>lim</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>lim_2</span> <span class=o>=</span> <span class=n>lim</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>lim</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
        <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=n>i</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>lim_2</span><span class=p>);</span>

    <span class=n>FFT</span><span class=p>(</span><span class=n>ff</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>lim</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>

    <span class=n>FFT</span><span class=p>(</span><span class=n>ff</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
    
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span> <span class=o>+</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d &#34;</span><span class=p>,</span> <span class=kt>int</span><span class=p>(</span><span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>));</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div>
</details>
</div>
<h3 id=ntt-p3803-多项式乘法>NTT P3803 多项式乘法<a hidden class=anchor aria-hidden=true href=#ntt-p3803-多项式乘法>#</a></h3>
<p>NTT 再来一遍。</p>
<div class=toc>
<details>
<summary markdown=span>NTT 模板（P3803 多项式乘法）</summary>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>const</span> <span class=n>ll</span> <span class=n>mod</span> <span class=o>=</span> <span class=mi>998244353</span><span class=p>,</span> <span class=n>g</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
<span class=k>const</span> <span class=n>ll</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mf>4e6</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>

<span class=n>ll</span> <span class=nf>qpow</span><span class=p>(</span><span class=n>ll</span> <span class=n>a</span><span class=p>,</span> <span class=n>ll</span> <span class=n>b</span><span class=p>,</span> <span class=n>ll</span> <span class=n>p</span> <span class=o>=</span> <span class=n>mod</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>ll</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>p</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(;</span> <span class=n>b</span><span class=p>;</span> <span class=n>b</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>ret</span> <span class=o>=</span> <span class=n>a</span> <span class=o>*</span> <span class=n>ret</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
        <span class=n>a</span> <span class=o>=</span> <span class=n>a</span> <span class=o>*</span> <span class=n>a</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>ll</span> <span class=nf>inv</span><span class=p>(</span><span class=n>ll</span> <span class=n>a</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>qpow</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>mod</span> <span class=o>-</span> <span class=mi>2</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>ll</span> <span class=nf>mo</span><span class=p>(</span><span class=n>ll</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=n>mod</span><span class=p>)</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>const</span> <span class=n>ll</span> <span class=n>g_inv</span> <span class=o>=</span> <span class=n>inv</span><span class=p>(</span><span class=n>g</span><span class=p>);</span>

<span class=n>ll</span> <span class=n>ff</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span> <span class=n>gg</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
<span class=kt>int</span> <span class=n>rev</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>

<span class=kt>void</span> <span class=nf>NTT</span><span class=p>(</span><span class=n>ll</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
            <span class=n>swap</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>f</span><span class=p>[</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ll</span> <span class=n>tg</span> <span class=o>=</span> <span class=n>type</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=mi>3</span> <span class=o>:</span> <span class=n>g_inv</span><span class=p>;</span>
        <span class=n>ll</span> <span class=n>gn</span> <span class=o>=</span> <span class=n>qpow</span><span class=p>(</span><span class=n>tg</span><span class=p>,</span> <span class=p>(</span><span class=n>mod</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>h</span><span class=p>);</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>j</span> <span class=o>+=</span> <span class=n>h</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ll</span> <span class=n>g</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>j</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>ll</span> <span class=n>f1</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>g</span> <span class=o>*</span> <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>mo</span><span class=p>(</span><span class=n>f1</span> <span class=o>+</span> <span class=n>f2</span><span class=p>);</span>
                <span class=n>f</span><span class=p>[</span><span class=n>k</span> <span class=o>+</span> <span class=n>h</span> <span class=o>/</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>mo</span><span class=p>(</span><span class=n>f1</span> <span class=o>-</span> <span class=n>f2</span><span class=p>);</span>
                <span class=n>g</span> <span class=o>=</span> <span class=n>g</span> <span class=o>*</span> <span class=n>gn</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=n>ll</span> <span class=n>lim_inv</span> <span class=o>=</span> <span class=n>inv</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>lim_inv</span> <span class=o>%</span> <span class=n>mod</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=n>rr</span><span class=p>(),</span> <span class=n>m</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>gg</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>rr</span><span class=p>();</span>

    <span class=kt>int</span> <span class=n>lim</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lim_2</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>lim</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>+</span> <span class=n>m</span><span class=p>)</span>
        <span class=n>lim</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>lim_2</span> <span class=o>=</span> <span class=n>lim</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>lim</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
        <span class=n>rev</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>rev</span><span class=p>[</span><span class=n>i</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=n>i</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>lim_2</span><span class=p>);</span>

    <span class=n>NTT</span><span class=p>(</span><span class=n>ff</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
    <span class=n>NTT</span><span class=p>(</span><span class=n>gg</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>lim</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>gg</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>

    <span class=n>NTT</span><span class=p>(</span><span class=n>ff</span><span class=p>,</span> <span class=n>lim</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span> <span class=o>+</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%lld &#34;</span><span class=p>,</span> <span class=n>ff</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div>
</details>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://rogeryoungh.github.io/blog/tags/%E5%A4%9A%E9%A1%B9%E5%BC%8F/>多项式</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://rogeryoungh.github.io/blog/post/hello-world-hugo/>
<span class=title>Next Page »</span>
<br>
<span>迁移博客到 Hugo</span>
</a>
</nav>
<blockquote>
<p class=copyright-item>
本文作者： rogeryoungh。
许可协议：<a href=https://creativecommons.org/licenses/by-sa/4.0/deed.zh target=_blank>CC BY-SA 4.0</a>。
转载请署名！
</p>
<p class=copyright-item>
撰写时间：2021-07-22，
<a href=https://github.com/rogeryoungh/blog/commits/main/content/post/learn-fft.md target=_blank>更新历史</a>。
</p>
</blockquote>
</footer><div id=vcomments></div>
<script src=//unpkg.com/valine/dist/Valine.min.js></script>
<script type=text/javascript>new Valine({el:'#vcomments',appId:'FIvl3vmw2mH3naQEJhErblHr-gzGzoHsz',appKey:'BhvzpBrJqPPzfK5phjDBiBb4',avatar:'mp',placeholder:'说点什么吧...',visitor:'false'})</script>
</article>
</main>
<footer class=footer>
<span>© 2021 <a href=/blog>Roger Young</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top id=gototop aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body>
</html>